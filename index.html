    <script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>
    <script>
        let productData = [];
        let refillList = [];
        let scanMode = null;
        let lastScannedCode = null;
        let lastScannedTime = 0;
        const SCAN_COOLDOWN = 2000; // 重複スキャン防止

        async function loadProductData() {
            try {
                const response = await fetch('product-data.json');
                if (!response.ok) throw new Error(`HTTPエラー: ${response.status}`);
                productData = await response.json();
                if (productData.length === 0) {
                    console.error('商品データが空です。');
                    document.getElementById('status').textContent = '商品データが空です。';
                } else {
                    console.log('商品データをロードしました:', productData);
                }
            } catch (error) {
                console.error('商品データのロードに失敗:', error);
                document.getElementById('status').textContent = '商品データのロードに失敗しました。';
            }
        }

        function startScanning(mode) {
            scanMode = mode;
            const statusElement = document.getElementById('status');
            statusElement.textContent = 'スキャンを開始しています...';

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#reader'),
                    constraints: {
                        width: { min: 320, ideal: 640, max: 1280 },
                        height: { min: 240, ideal: 480, max: 720 },
                        facingMode: "environment"
                    }
                },
                decoder: {
                    readers: ["ean_reader"],
                    multiple: false
                },
                locator: {
                    halfSample: true,
                    patchSize: "medium"
                },
                numOfWorkers: navigator.hardwareConcurrency ? navigator.hardwareConcurrency : 4,
                locate: true,
                frequency: 10 // デコードの頻度を下げる
            }, function(err) {
                if (err) {
                    console.error('Quagga初期化エラー:', err);
                    statusElement.textContent = 'エラー: スキャン初期化に失敗';
                    return;
                }
                Quagga.start();
                statusElement.textContent = 'スキャン中...';
            });

            Quagga.onDetected(processScanResult);
        }

        function stopScanning() {
            Quagga.stop();
            document.getElementById('status').textContent = 'スキャンを停止しました。';
        }

        function processScanResult(result) {
            if (!result || !result.codeResult || !result.codeResult.code) return;
            const code = result.codeResult.code.trim();
            console.log(`スキャンされたバーコード: ${code}`);

            const now = Date.now();
            if (code === lastScannedCode && now - lastScannedTime < SCAN_COOLDOWN) {
                console.log(`重複スキャンを防止: ${code}`);
                return;
            }
            lastScannedCode = code;
            lastScannedTime = now;

            if (scanMode === 'sales') handleSalesScan(code);
            else if (scanMode === 'warehouse') handleWarehouseScan(code);
        }

        function handleSalesScan(code) {
            const product = productData.find(item => item.barCode === code);
            if (product) {
                if (!refillList.some(item => item.code === product.barCode)) {
                    refillList.push({ code: product.barCode, name: product.name, status: '要補充' });
                    updateRefillList();
                    showStatusMessage(`追加: ${product.name}`, 'success');
                }
            } else {
                showStatusMessage(`バーコード ${code} は商品データに登録されていません。`, 'error');
            }
        }

        function handleWarehouseScan(code) {
            const product = productData.find(item => item.salesCode === code);
            if (product) {
                const existingItem = refillList.find(item => item.code === product.barCode);
                if (existingItem) {
                    existingItem.status = 'ピッキング';
                    updateRefillList();
                    showStatusMessage(`${product.name} をピッキング状態に更新`, 'success');
                }
            } else {
                showStatusMessage(`バーコード ${code} は商品データに登録されていません。`, 'error');
            }
        }

        function updateRefillList() {
            const listElement = document.getElementById('salesRefillList');
            listElement.innerHTML = '';
            refillList.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.name} (${item.status})`;
                if (item.status === 'ピッキング') {
                    li.classList.add('picking-status');
                }
                listElement.appendChild(li);
            });
        }

        function showStatusMessage(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = '';
            statusElement.classList.add(type === 'success' ? 'success' : 'error');
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        document.addEventListener('DOMContentLoaded', loadProductData);
    </script>
</body>
</html>
